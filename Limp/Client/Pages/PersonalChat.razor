@page "/user/{partnerName?}"
@using Limp.Client.Utilities;
@using Limp.Shared.Models;
@using Microsoft.AspNetCore.SignalR.Client;
@inject NavigationManager Navigation
@inject ILimpHttpClient _limpHttpClient;
@inject IJSRuntime jS;

<h1>Your chat with @partnerName</h1>

<div>
    <label>You:</label>
    <input @bind="messageInput"/>
    <button @onclick="Dispatch" disabled="@(!IsConnected)">Send</button>
</div>

@foreach (var message in messages)
{
    <div>
        <span>@message.SenderUsername:</span><span>@message.Payload</span>
    </div>
}

@code {
    [Parameter]
    public string? partnerName { get; set; }
    [Parameter]
    public string? myName { get; set; }
    private HubConnection? hubConnection;
    private List<Message> messages { get; set; } = new();
    private string messageInput = string.Empty;

    private async Task<string> GetUserNameAsync()
    {
        string? accessToken = await jS.InvokeAsync<string>("localStorage.getItem", "access-token");

        if (accessToken == null)
            return "Anonymous";

        var username = await _limpHttpClient.GetUserNameFromAccessTokenAsync(accessToken);

        return username;
    }


    protected override async Task OnInitializedAsync()
    {
        myName = await GetUserNameAsync();

        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/messageDispatcherHub"))
        .Build();

        hubConnection.On<Message>("ReceiveMessage", message =>
        {
            messages.Add(message);
            StateHasChanged();
        });

        await hubConnection.StartAsync();

        await hubConnection.SendAsync("SetUsername", myName!);
    }

    public bool IsConnected =>
        hubConnection?.State == HubConnectionState.Connected;

    private async Task Dispatch()
    {
        Message messageToSend = new Message
        {
            Payload = messageInput,
            DateSent = DateTime.UtcNow,
                TargetGroup = partnerName!,
                SenderUsername = myName!,
        };

        await hubConnection.SendAsync("Dispatch", messageToSend);

        messageInput = string.Empty;

        messageToSend.SenderUsername = "You";

        messages.Add(messageToSend);
    }
}
