@page "/users"
@using ClientServerCommon.Models;
@using Limp.Client.HubInteraction.Handlers.Helpers;
@using Limp.Client.Pages.AuthenticationChecks
@using Limp.Client.Services.HubService.UsersService;
@using Limp.Client.Services.HubServices.CommonServices.SubscriptionService;
@using System.Collections.Concurrent;
@using Limp.Client.Services;
@using Limp.Client.Services.JWTReader;
@using Limp.Client.UIComponents.ContactItem
@inject NavigationManager _navigationManager
@inject IJSRuntime _jS
@inject IUsersService _usersService
@inject IHubServiceSubscriptionManager _hubServiceSubscriptionManager
@implements IDisposable

<PageTitle>Users Online</PageTitle>

<AuthenticatedView>
    <AuthenticatedContent>
    <div class="ApplicationContent">
        <div class="p-2">
            @foreach (var connection in userConnections.Where(x => x.Username != myUsername && x.ConnectionIds.Count > 0))
            {
                <ContactBar Username="@connection.Username"
                        IsOnline="true"
                        OnClickCallback="@(()=>_navigationManager.NavigateTo($"user/{connection.Username}"))" />
            }
        </div>
    </div>
    </AuthenticatedContent>
    <UnauthenticatedContent>
        <UnAuthorized/>
    </UnauthenticatedContent>
</AuthenticatedView>

@code {
    private ConcurrentBag<UserConnection> userConnections { get; set; } = new();
    private string myUsername { get; set; } = String.Empty;
    private Guid ComponentId { get; set; }

    public void Dispose() => _hubServiceSubscriptionManager.RemoveComponentCallbacks(ComponentId);

    protected override async Task OnInitializedAsync()
    {
        //Shortcut for cases when user was not yet authenticated
        if (string.IsNullOrWhiteSpace(await JWTHelper.GetAccessToken(_jS))) return;

        //This id will be needed on dispose stage
        //On dispose stage we need to clear out all of the component event subscriptions
        ComponentId = Guid.NewGuid();

        //Reading username from access-token
        myUsername = await GetMyUsername();

        //If username was not read, ask user to relogin
        if(string.IsNullOrWhiteSpace(myUsername))
        {
            _navigationManager.NavigateTo("/login");
            return;
        }

        //Subscribing to server event of updating online users
        _hubServiceSubscriptionManager
            .AddCallback<List<UserConnection>>(UpdateUsersList, "ReceiveOnlineUsers", ComponentId);

        //Actualizing list of users that currently online
        await _usersService.ActualizeConnectedUsersAsync();
    }

    private async Task<string> GetMyUsername()
    {
        string? accessToken = await JWTHelper.GetAccessToken(_jS);
        if (string.IsNullOrWhiteSpace(accessToken))
            return string.Empty;

        myUsername = TokenReader.GetUsernameFromAccessToken(accessToken);

        return myUsername;
    }

    private void UpdateUsersList(List<UserConnection> updatedUserConnections)
    {
        userConnections.Clear();
        foreach (var connection in updatedUserConnections)
        {
            userConnections.Add(connection);
        }
        StateHasChanged();
    }
}
