@page "/user/{partnerName?}"
@using Limp.Client.Utilities;
@using Limp.Shared.Models;
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@inject IJSRuntime jS;
@implements IAsyncDisposable

<PageTitle>Chat with @partnerName</PageTitle>

<h1>Your chat with @partnerName</h1>

<div>
    <label>You:</label>
    <input @bind="messageInput"/>
    <button @onclick="SendMessage" disabled="@(!IsConnected)">Send</button>
</div>

@foreach (var message in messages)
{
    <div>
        <span>@message.SenderUsername:</span><span>@message.Payload</span>
    </div>
}

@code {
    [Parameter]
    public string? partnerName { get; set; }
    [Parameter]
    public string? myName { get; set; }
    private HubConnection? hubConnection;
    private HubConnection? usersHub;
    private List<Message> messages { get; set; } = new();
    private string messageInput = string.Empty; 
    private string myConnectionId { get; set; } = string.Empty;
    private List<UserConnections> userConnections { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        usersHub = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/usersHub"))
        .Build();

        usersHub.On<List<UserConnections>>("ReceiveOnlineUsers", updatedTrackedUserConnections =>
        {
            userConnections = updatedTrackedUserConnections;
            StateHasChanged();
        });

        usersHub.On<string>("ReceiveConnectionId", conId =>
        {
            myConnectionId = conId;
            StateHasChanged();
        });

        await usersHub.StartAsync();

        await usersHub.SendAsync("SetUsername", await jS.InvokeAsync<string>("localStorage.getItem", "access-token"));

        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/messageDispatcherHub"))
        .Build();

        hubConnection.On<Message>("ReceiveMessage", message =>
        {
            messages.Add(message);
            StateHasChanged();
        });

        hubConnection.On<string>("OnMyNameResolve", value =>
        {
            myName = value;
        });

        await hubConnection.StartAsync();

        await hubConnection.SendAsync("SetUsername", await jS.InvokeAsync<string>("localStorage.getItem", "access-token"));
    }

    public bool IsConnected =>
        hubConnection?.State == HubConnectionState.Connected;

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageInput))
            return;

        Message messageToSend = new Message
        {
            Payload = messageInput,
            DateSent = DateTime.UtcNow,
            TargetGroup = partnerName!,
            SenderUsername = myName!,
        };

        await hubConnection.SendAsync("Dispatch", messageToSend);

        messageInput = string.Empty;

        messageToSend.SenderUsername = "You";

        messages.Add(messageToSend);

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if(hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
