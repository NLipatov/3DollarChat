@page "/users"
@using Limp.Client.HubInteraction.Handlers;
@using Limp.Client.HubInteraction;
@using ClientServerCommon.Models;
@using Limp.Client.Cryptography;
@using Limp.Client.Cryptography.KeyStorage;
@using Limp.Client.HubInteraction.Handlers.Helpers;
@using Limp.Client.HubInteraction.Handlers.MessageDispatcherHub.AESOfferHandling;
@using Limp.Client.HubInteraction.HubObservers.Implementations.AuthHub;
@using Limp.Client.HubInteraction.HubObservers.Implementations.UsersHubObserver.EventTypes;
@using Limp.Client.HubInteraction.HubObservers;
@using Limp.Client.TopicStorage;
@using Limp.Client.Utilities;
@using LimpShared.Authentification;
@using Microsoft.AspNetCore.SignalR.Client;
@inject NavigationManager _navigationManager
@inject ICryptographyService _cryptographyService
@inject IMessageBox _messageBox
@inject IAESOfferHandler _aesOfferHandler
@using ClientServerCommon.Models.Login;
@inject IJSRuntime _jS
@inject IHubObserver<UsersHubEvent> _usersHubObserver
@implements IAsyncDisposable

<PageTitle>Users Online</PageTitle>

<div style="display: flex; flex-direction: column; gap: 10px;">
    @foreach (var connection in userConnections.Where(x=>!x.ConnectionIds.Contains(myConnectionId) && x.ConnectionIds.Count > 0))
    {
        <div style="    
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid;
            height: 5vh;">
            <span>@connection.Username is looking for a chat!</span>
            <button @onclick="()=>RedirectToChat(connection.Username)">Start a chat</button>
        </div>
    }
</div>

@code {
    private List<UserConnections> userConnections { get; set; } = new();
    private string myConnectionId { get; set; } = string.Empty;
    private AuthHandler? _authHubHandler;
    private UsersHubInteractor? _usersHubHandler;
    private HubInteractor? _hubInteractor;
    private List<Guid> ActiveHandlers = new();

    private async Task RedirectToChat(string username)
    {
        _navigationManager.NavigateTo($"/user/{username}");
    }

    protected override async Task OnInitializedAsync()
    {
        _hubInteractor = new HubInteractor(_navigationManager, _jS, _messageBox, _aesOfferHandler);

        _authHubHandler = new AuthHandler(_navigationManager, _jS);
        _usersHubHandler = new UsersHubInteractor(_navigationManager, _jS, _usersHubObserver);

        if (String.IsNullOrWhiteSpace(await JWTHelper.GetAccessToken(_jS)))
        {
            _navigationManager.NavigateTo("login");
            return;
        }

        AuthHubSubscriptionManager.SubscribeToJWTPairRefresh(async (result) =>
        {
            JWTPair? pair = result.JWTPair;
            if (pair == null || String.IsNullOrWhiteSpace(pair.AccessToken) || String.IsNullOrWhiteSpace(pair.RefreshToken.Token))
                _navigationManager.NavigateTo("/login");

            if (result.Result == AuthResultType.Success)
            {
                await _jS.InvokeVoidAsync("localStorage.setItem", "access-token", pair!.AccessToken);
                await _jS.InvokeVoidAsync("localStorage.setItem", "refresh-token", pair!.RefreshToken.Token);
            }
        });

        ActiveHandlers.Add(_usersHubObserver.AddHandler<string>(UsersHubEvent.ConnectionIdReceived,
        async (id) =>
        {
            myConnectionId = id;
        }));

        ActiveHandlers.Add(_usersHubObserver.AddHandler<List<UserConnections>>(UsersHubEvent.ConnectedUsersListReceived,
        async (userConnectionsList) =>
        {
            userConnections = userConnectionsList;
            StateHasChanged();
        }));

        ActiveHandlers.Add(_usersHubObserver.AddHandler<string>(UsersHubEvent.MyUsernameResolved,
        async (username) =>
        {
            if (_hubInteractor != null)
            {
                await _hubInteractor.ConnectToMessageDispatcherHubAsync(cryptographyService: _cryptographyService, onOnlineUsersReceive: (userConnectionsList) =>
                {
                    userConnections = userConnectionsList;
                    StateHasChanged();
                });
            }
        }));

        await _authHubHandler.ConnectAsync();
        await _usersHubHandler.ConnectAsync();
    }

    public async ValueTask DisposeAsync()
    {
        _usersHubObserver.RemoveHandlers(ActiveHandlers);

        await _usersHubHandler.DisposeAsync();
        await _authHubHandler.DisposeAsync();
        await _hubInteractor?.DisposeAsync();
    }
}
