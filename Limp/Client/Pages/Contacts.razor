@page "/contacts"
@using Limp.Client.Services.ContactsProvider;
@using Limp.Client.UIComponents.ContactItem;
@inject NavigationManager _navigationManager;
@inject IContactsProvider _contactsProvider;
@inject IJSRuntime _jSRuntime;

<div style="
    padding: 0.5rem 1rem;    
    width: 100%;
    height: 100%;
    overflow: auto;">
    <div>
        <div style="
        padding: 1rem;
        background-color: whitesmoke;
        margin: 10px;">
            <h1>Search for a new contact!</h1>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon1">@("@")</span>
                </div>
                <input type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1" @bind-value="NewContactUsername">
            </div>
            <Button Color="ButtonColor.Primary" @onclick="OnAddContactAttempt">
                <span>Search for a user</span>
                <Icon Name="IconName.Search" />
            </Button>
        </div>

        @if(ContactsList.Any())
        {
            <div style="    
                    padding: 1rem;
                    background-color: whitesmoke;
                    margin: 10px;">
                <div style="    
                        display: flex;
                        justify-content: space-between;">
                    <h1>Your contacts:</h1>
                    @if(!contactEditionMode)
                    {
                        <Button Color="ButtonColor.Primary" Outline="true" @onclick="ToggleContactEditionMode">Edit</Button>
                    }
                    else
                    {
                        <Button Color="ButtonColor.Success" Outline="true" @onclick="ToggleContactEditionMode">Done</Button>
                    }
                </div>
                <div>
                    @foreach (var contact in ContactsList.OrderByDescending(x => x.LastMessage))
                    {
                        <div style="
                                display: flex;
                                align-items: center;
                                gap: 10px;">
                            @if(contactEditionMode)
                            {
                                <Icon Style="color: red; font-size: 20px; cursor: pointer;" Name="IconName.DashCircle"
                          @onclick="(async() => await RemoveContact(contact.Username))"></Icon>
                            }
                            <ContactBar Username=@contact.Username
                                IsOnline=@contact.IsOnline
                                OnClickCallback=@(() => _navigationManager.NavigateTo($"/user/{contact.Username}")) 
                                Style="width: 100%;"/>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <Callout Type="CalloutType.Tip">
                <div style="display: flex; flex-direction: column;">
                    <h3>Your contact book is empty</h3>
                    <span>Add someone and start a new chat!</span>
                </div>
            </Callout>
        }
    </div>
</div>

<Modal @ref="modal" Title="Add user to contacts">
    <BodyTemplate>
        @if (ContactsList.Any(x => x.Username == NewContactUsername))
        {
            <span>
                @NewContactUsername is already in your contact book
            </span>
        }
        else
        {
            @ModalBody
        }
    </BodyTemplate>
    <FooterTemplate>
        @if(IsUserExists)
        {
            @if(ContactsList.Any(x=>x.Username == NewContactUsername))
            {
                <Button Color="ButtonColor.Secondary" @onclick="HideModal">Hide</Button>
            }
            else
            {
                <Button Color="ButtonColor.Danger" @onclick="HideModal">Cancel</Button>
                <Button Color="ButtonColor.Success" @onclick="(async ()=>await HandleContactAddition(NewContactUsername))">Confirm</Button>
            }
        }
        else
        {
            <Button Color="ButtonColor.Secondary" @onclick="HideModal">Hide</Button>
        }
    </FooterTemplate>
</Modal>

@code {
    private Modal modal = default!;
    private string ModalBody = string.Empty;
    private bool IsUserExists = false;
    private string NewContactUsername = string.Empty;
    private List<Contact> ContactsList = new();
    private bool contactEditionMode = false;

    private async Task ToggleContactEditionMode()
    {
        contactEditionMode = !contactEditionMode;
        StateHasChanged();
    }

    private async Task RemoveContact(string username)
    {
        //Get contact out of client's browser local storage
        await _contactsProvider.RemoveContact(username, _jSRuntime);

        //If there is no one in contact book left, toggle change mode back to false automatically
        if(!(await _contactsProvider.GetContacts(_jSRuntime)).Any())
        {
            await ToggleContactEditionMode();
        }

        //update displayed contacts in UI component
        await UpdateContacts();
    }

    private async Task ShowModal()
    {
        await modal.ShowAsync();
    }

    private async Task HideModal()
    {
        await modal.HideAsync();
    }

    private async Task OnAddContactAttempt()
    {
        if (!string.IsNullOrWhiteSpace(NewContactUsername))
        {
            IsUserExists = true;
            if (IsUserExists)
            {
                ModalBody = $"Confirm adding '{NewContactUsername}' as new contact";
                await ShowModal();
            }
            else
            {
                ModalBody = $"There is no user with such username"; 
                await ShowModal();
            }
        }
    }

    private async Task HandleContactAddition(string username)
    {
        await _contactsProvider.AddContact(NewContactUsername, _jSRuntime);
        await HideModal();
        await UpdateContacts();
    }

    public class Contact
    {
        public string Username { get; set; }
        public bool IsOnline { get; set; } = false;
        public DateTime LastMessage { get; set; } = DateTime.UtcNow;
    }

    protected override async Task OnInitializedAsync()
    {
        await UpdateContacts();
    }

    private async Task UpdateContacts()
    {
        List<string> contacts = await _contactsProvider.GetContacts(_jSRuntime);
        ContactsList = contacts.Select(x =>
        new Contact
            {
                Username = x,
                IsOnline = false,
                LastMessage = DateTime.UtcNow
            }).ToList();

        StateHasChanged();
        
    }
}