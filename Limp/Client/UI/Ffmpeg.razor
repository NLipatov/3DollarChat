@page "/ffmpeg"
@using FFmpegBlazor
@using Ethachat.Client.Services.VideoStreamingService
@using Ethachat.Client.Services.VideoStreamingService.FileTypes
@using System.Text
@inject IJSRuntime _JsRuntime
@inject IHlsStreamingService HlsStreamingService
@inherits Ethachat.Client.UI.CommonComponents.BaseComponents.BaseEventListeningComponent

<InputFile OnChange="OnFileUpload"/><br/> <br/>
<video width="300" height="200" autoplay controls/><br/><br/>

@code
{
    async void OnFileUpload(InputFileChangeEventArgs v)
    {
        await FFmpegFactory.Init(_JsRuntime);
        using (var memoryStream = new MemoryStream())
        {
            var file = v.GetMultipleFiles()[0];
            await file
                .OpenReadStream(long.MaxValue)
                .CopyToAsync(memoryStream);
            
            var playlist = await HlsStreamingService.ToM3U8Async(memoryStream.ToArray(), ExtentionType.MP4);
        
            var playlistBytes = Encoding.UTF8.GetBytes(playlist.M3U8Content);
            var playlistUrl =
                FFmpegFactory.CreateURLFromBuffer(playlistBytes, $"{playlist.VideoId}Playlist.m3u8", "application/vnd.apple.mpegurl");
        
            await _JsRuntime.InvokeVoidAsync("startStream", playlistUrl);
        
            await _JsRuntime.InvokeVoidAsync("revokeBlobUrl", playlistUrl);
        }
    }
}