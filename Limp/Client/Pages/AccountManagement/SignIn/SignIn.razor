@using System.Text.Json;
@using System.Text;
@using System.Web;
@using Limp.Client.Pages.AccountManagement.LogicHandlers;
@using Limp.Client.Services.HubConnectionProvider;
@using Limp.Client.Services.HubServices.CommonServices.SubscriptionService;
@using Limp.Client.Services.HubServices.HubServices.Implementations.AuthService
@using Limp.Client.Services.HubServices.HubServices.Implementations.UsersService
@using Limp.Client.UIComponents.InputForms.Login
@using LimpShared.Models.Authentication.Models;
@using LimpShared.Models.Authentication.Models.UserAuthentication;
@using Microsoft.AspNetCore.SignalR.Client;
@inject IConfiguration _configuration;
@inject IJSRuntime js
@inject NavigationManager _navigationManager
@inject IHubServiceSubscriptionManager _hubServiceSubscriptionManager
@inject IAuthService _authService
@inject ILoginHandler _loginHandler
@inject IUsersService _usersService
@inject IHubConnectionProvider _hubConnectionProvider
@page "/signIn"

<LoginForm 
    OnLoginEvent="async (dto) => await OnLogIn(dto)"
    LoginAttemptResult="lasttokenFetchResult" />

@code {
    private AuthResult? lasttokenFetchResult = new();
    private HubConnection? hubConnection;

    private async void HandleOnLogInResponse(AuthResult authResult)
    {
        lasttokenFetchResult = authResult;

        if (lasttokenFetchResult.Result != AuthResultType.Fail)
        {
            lasttokenFetchResult.Message = "You're logged in.";
            _navigationManager.NavigateTo("/users");
        }
        else if (string.IsNullOrWhiteSpace(authResult?.JwtPair?.AccessToken) || string.IsNullOrWhiteSpace(authResult?.JwtPair?.RefreshToken?.Token))
        {
            lasttokenFetchResult = new AuthResult
                {
                    Message = "Server authentification response was invalid",
                    Result = AuthResultType.Fail,
                };
        }

        StateHasChanged();
    }

    private async Task OnLogIn(UserAuthentication loggingInUser)
    {
        await _loginHandler.OnLogIn(loggingInUser, HandleOnLogInResponse);
    }
}
